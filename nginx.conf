# Map for WebSocket support (required for n8n)
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# --- Redirect HTTP to HTTPS ---
server {
    listen 80;
    server_name skyup.online;
    return 301 https://$host$request_uri;
}

# --- Ollama Web UI Configuration (skyup.online root) ---
server {
    listen 443 ssl;
    http2 on;
    server_name skyup.online;

    ssl_certificate /etc/letsencrypt/live/skyup.online/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/skyup.online/privkey.pem;
    
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    client_max_body_size 100M;

    location / {
        # ðŸŒŸ FIX: Proxy pass to the Ollama Web UI (port 3001)
        proxy_pass http://127.0.0.1:8080; 
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # ðŸŒŸ IMPROVEMENT: Headers required for WebSocket connections (used by Web UI)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        proxy_buffering off;
        
        proxy_read_timeout 300s; 
        proxy_send_timeout 300s;
        
        proxy_http_version 1.1;
    }
}


# --- 1. N8N Configuration (n8n.skyup.online) ---
server {
    listen 80;
    server_name n8n.skyup.online;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    http2 on;
    server_name n8n.skyup.online;

    # Wildcard Certificate
    ssl_certificate /etc/letsencrypt/live/skyup.online/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/skyup.online/privkey.pem;

    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    client_max_body_size 100M;

    location / {
        proxy_pass http://127.0.0.1:5678;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket headers
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_buffering off;
    }
}

# --- Sim Studio (sim.skyup.online) - Full working config ---
# Redirect HTTP â†’ HTTPS
server {
    listen 80;
    server_name sim.skyup.online;
    return 301 https://$host$request_uri;
}

# Main HTTPS server block
server {
    listen 443 ssl;
    http2 on;
    server_name sim.skyup.online;

    # SSL settings (your Letâ€™s Encrypt wildcard cert)
    ssl_certificate      /etc/letsencrypt/live/skyup.online/fullchain.pem;
    ssl_certificate_key  /etc/letsencrypt/live/skyup.online/privkey.pem;

    ssl_session_cache    shared:SSL:10m;
    ssl_session_timeout  1d;
    ssl_protocols        TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    client_max_body_size 100M;

    # 1. Main Next.js app (port 3001)
    location / {
        proxy_pass http://127.0.0.1:3001;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support (needed for Next.js features)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        # Increase timeouts for long-running agent executions
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }

    # 2. Realtime socket server (port 3002) - this is the critical part you were missing
    location /socket/ {
        proxy_pass http://127.0.0.1:3002;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Required for Socket.IO / WebSocket
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Increase timeout for long-lived connections
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }

    # Optional: if you ever expose the API separately (usually not needed)
    # location /api/ {
    #     proxy_pass http://127.0.0.1:3001/api/;
    #     ... same headers as above
    # }
}