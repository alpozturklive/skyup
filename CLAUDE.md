# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Information

- **GitHub**: https://github.com/alpozturklive/skyup
- **Default branch**: main (use this for PRs)
- **Language**: Shell scripts
- **License**: MIT

## Overview

SkyUp is a self-hosted application stack (Release v2.0 - Horizon) that runs AI applications and workflow tools using **Podman** and **podman-compose**. It's designed for host-only access (127.0.0.1) with optional HTTPS setup for production.

## Stack Architecture

### Service Topology

The stack consists of 5 containerized services with the following dependencies:

```
nginx (reverse proxy)
  ├─> open-webui:8080 (AI chat interface)
  │     ├─> postgres:5432 (database)
  │     └─> ollama:11434 (LLM service)
  └─> n8n:5678 (workflow automation)
        └─> postgres:5432 (database)
```

### Database Structure

PostgreSQL runs with pgvector extension and hosts multiple databases:
- `postgres` - default admin database
- `n8n` - owned by `n8n_user` (n8n workflow metadata and credentials)
- `open_webui` - owned by `open_webui_user` (has vector and uuid-ossp extensions)
- `memory` - owned by `memory_user` (for n8n workflow chat memory and data storage)

Database initialization happens via `/initdb/01-create-extra-dbs.sh` which runs on first container startup.

### Data Persistence

All persistent data is stored in `.podman/` directory:
- `.podman/pgvector-varlibpostgresqldata/` - PostgreSQL data
- `.podman/open-webui-appbackenddata/` - Open WebUI backend data
- `.podman/n8n-homenode.n8n/` - n8n workflow data

### Network Configuration

Services bind to localhost only for security:
- Open WebUI: `127.0.0.1:8080`
- Ollama: `127.0.0.1:11434`
- n8n: `127.0.0.1:5678` (uses basic auth, credentials in .env)
- PostgreSQL: `127.0.0.1:5432`
- Nginx: `0.0.0.0:80`, `0.0.0.0:443` (for production HTTPS)

Nginx configuration in `nginx.conf` routes:
- `skyup.online` → open-webui container
- `n8n.skyup.online` → n8n container

Note: Container-to-container communication uses service names (e.g., `http://ollama:11434`, `http://open-webui:8080`), NOT localhost.

## Common Commands

### Initial Setup

```bash
# Generate .env file and create data directories
chmod +x init-env.sh
./init-env.sh

# Start all services
podman-compose up -d

# View logs
podman-compose logs -f [service-name]

# Stop services
podman-compose down
```

### Environment Management

The `.env` file is auto-generated by `init-env.sh` and contains:
- Database passwords (32-char random strings via `openssl rand`)
- Database usernames and names
- n8n basic auth credentials

The init script preserves existing passwords when re-run but resets PostgreSQL and n8n data directories.

### Database Access

```bash
# Connect as postgres admin
psql -h 127.0.0.1 -p 5432 -U postgres postgres

# Connect to application databases
psql -h 127.0.0.1 -U n8n_user n8n
psql -h 127.0.0.1 -U open_webui_user open_webui
psql -h 127.0.0.1 -U memory_user memory
```

### Service Management

```bash
# Restart individual service
podman-compose restart [service-name]

# View service status
podman ps

# Execute command in container
podman exec -it [container-name] [command]
```

### Backup

```bash
# Create full backup
tar -czf skyup-backup-$(date +%F).tar.gz \
  .podman/ .env podman-compose.yml initdb/ nginx.conf
```

## Common Issues

### n8n Permission Denied / Crash Loop

The n8n container runs as non-root user (UID 1000) and may fail if host directory permissions are incorrect.

**Fix:**
```bash
sudo chown -R 1000:1000 .podman/n8n-homenode.n8n
podman-compose up -d
```

### PostgreSQL Connection Issues

Ensure you're using the correct service name in container-to-container communication. From within containers, use `postgres` as the hostname, not `127.0.0.1` or `localhost`.

## Important Configuration Details

### Ollama GPU Support

Ollama container has `OLLAMA_VULKAN: 1` environment variable set for GPU acceleration.

### Open WebUI First User

The first user to register automatically becomes admin. Navigate to `http://127.0.0.1:8080` after startup to create admin account.

### HTTPS/Production Setup

For production deployments:
1. Point DNS records to server
2. Open ports 80 and 443
3. Install certbot: `sudo dnf install -y certbot python3-certbot-nginx`
4. Obtain certificates (referenced in nginx.conf as `/etc/letsencrypt/live/skyup.online/`)
5. Update `nginx.conf` with your domain names

## Development Notes

- The codebase uses Podman (not Docker) for containerization
- Services use `restart: unless-stopped` policy
- Open WebUI has a health check configured (curl to /health endpoint)
- Database init script references undefined env vars: `N8N_WORKFLOW_DB_USER` and `N8N_WORKFLOW_DB_PASSWORD` (not generated by init-env.sh)
